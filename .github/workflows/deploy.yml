name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual triggering

# Prevent concurrent deployments
concurrency:
  group: production-deployment
  cancel-in-progress: false

jobs:
  # Wait for CI to pass before deploying
  deploy:
    name: Deploy to tachyonfuture.com
    runs-on: ubuntu-latest
    # Only run if not a draft PR or skip deploy
    if: "!contains(github.event.head_commit.message, '[skip deploy]')"
    environment:
      name: production
      url: https://meteo-beta.tachyonfuture.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H tachyonfuture.com >> ~/.ssh/known_hosts

      - name: Deploy to server
        id: deploy
        run: |
          ssh michael@tachyonfuture.com << 'ENDSSH'
            cd /home/michael/meteo-app

            # Show current commit
            echo "ðŸ“ Current commit: $(git log -1 --oneline)"
            echo ""

            # Run deployment script
            if ! bash scripts/deploy-beta.sh; then
              echo "âŒ Deployment script failed"
              exit 1
            fi

            # Show deployment result
            echo ""
            echo "âœ… Deployment completed successfully!"
            echo "ðŸ“¦ New commit: $(git log -1 --oneline)"
          ENDSSH

      - name: Wait for services to stabilize
        run: |
          echo "â³ Waiting 15 seconds for services to fully stabilize..."
          sleep 15

      - name: Verify deployment
        id: verify
        run: |
          echo "ðŸ” Verifying deployment health..."

          # Test frontend with retries
          for i in {1..5}; do
            if curl -f -s -o /dev/null -w "%{http_code}" https://meteo-beta.tachyonfuture.com | grep -q "200"; then
              echo "âœ… Frontend: OK (200)"
              break
            fi
            if [ $i -eq 5 ]; then
              echo "âŒ Frontend health check failed after 5 attempts"
              exit 1
            fi
            echo "â³ Frontend check $i/5 failed, retrying..."
            sleep 3
          done

          # Test backend API with retries
          for i in {1..5}; do
            RESPONSE=$(curl -f -s https://api.meteo-beta.tachyonfuture.com/api/health)
            if echo "$RESPONSE" | grep -q '"status":"ok"'; then
              echo "âœ… Backend API: OK"
              echo "$RESPONSE" | jq '.' || echo "$RESPONSE"
              break
            fi
            if [ $i -eq 5 ]; then
              echo "âŒ Backend API health check failed after 5 attempts"
              echo "Response: $RESPONSE"
              exit 1
            fi
            echo "â³ Backend check $i/5 failed, retrying..."
            sleep 3
          done

      - name: Run smoke tests
        run: |
          echo "ðŸ§ª Running smoke tests..."

          # Test weather API endpoint
          WEATHER_RESPONSE=$(curl -f -s "https://api.meteo-beta.tachyonfuture.com/api/weather/current?location=London")
          if echo "$WEATHER_RESPONSE" | grep -q '"temperature"'; then
            echo "âœ… Weather API: Working"
          else
            echo "âš ï¸ Weather API response unexpected: $WEATHER_RESPONSE"
          fi

          # Test locations search
          LOCATION_RESPONSE=$(curl -f -s "https://api.meteo-beta.tachyonfuture.com/api/locations/search?q=New%20York")
          if echo "$LOCATION_RESPONSE" | grep -q '\[.*\]'; then
            echo "âœ… Locations API: Working"
          else
            echo "âš ï¸ Locations API response unexpected: $LOCATION_RESPONSE"
          fi

      - name: Deployment summary
        if: always()
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### URLs" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ Frontend: https://meteo-beta.tachyonfuture.com" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”Œ API: https://api.meteo-beta.tachyonfuture.com/api/health" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.verify.outcome }}" == "success" ]; then
            echo "### Status: âœ… Healthy" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Status: âŒ Health checks failed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "## âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The deployment to production failed. Please check the logs above for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Troubleshooting:**" >> $GITHUB_STEP_SUMMARY
          echo "1. SSH into server: \`ssh michael@tachyonfuture.com\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Check logs: \`cd /home/michael/meteo-app && docker compose -f docker-compose.prod.yml logs -f\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Check container status: \`docker ps | grep meteo\`" >> $GITHUB_STEP_SUMMARY
