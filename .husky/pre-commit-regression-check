#!/bin/sh
# Pre-commit hook: Run critical regression tests
# Prevents "Old Location" bug from being re-introduced

echo "üîç Running critical regression tests..."

FRONTEND_CHANGED=0
BACKEND_CHANGED=0

# Check if geolocationService.js was modified (FRONTEND)
if git diff --cached --name-only | grep -q "frontend/src/services/geolocationService.js"; then
  echo "‚ö†Ô∏è  Frontend geolocationService.js modified - running regression tests..."
  FRONTEND_CHANGED=1

  # Run frontend regression tests
  cd frontend
  npm run test -- geolocationService.regression.test.js --run

  if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå CRITICAL REGRESSION DETECTED IN FRONTEND!"
    echo ""
    echo "The 'Old Location' bug has been re-introduced in geolocationService.js"
    echo "Please fix the issues before committing."
    echo ""
    echo "Common fix:"
    echo "  WRONG: address = 'Your Location'"
    echo "  RIGHT: address = \`\${latitude}, \${longitude}\`"
    echo ""
    echo "See: docs/troubleshooting/OLD_LOCATION_BUG_FIX.md"
    echo ""
    exit 1
  fi

  echo "‚úÖ Frontend regression tests passed"
  cd ..
fi

# Check if weatherService.js was modified (BACKEND)
if git diff --cached --name-only | grep -q "backend/services/weatherService.js"; then
  echo "‚ö†Ô∏è  Backend weatherService.js modified - running regression tests..."
  BACKEND_CHANGED=1

  # Run backend regression tests
  cd backend
  npm test -- weatherService.regression.test.js

  if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå CRITICAL REGRESSION DETECTED IN BACKEND!"
    echo ""
    echo "The 'Old Location' bug has been re-introduced in weatherService.js"
    echo "Please fix the issues before committing."
    echo ""
    echo "Common fix:"
    echo "  - Check for BOTH placeholder AND coordinate patterns"
    echo "  - Call reverseGeocodeNominatim when Visual Crossing returns placeholders"
    echo "  - Ensure isPlaceholder || isCoordinates logic is present"
    echo ""
    echo "See: docs/troubleshooting/OLD_LOCATION_BUG_FIX.md"
    echo ""
    exit 1
  fi

  echo "‚úÖ Backend regression tests passed"
  cd ..
fi

if [ $FRONTEND_CHANGED -eq 1 ] || [ $BACKEND_CHANGED -eq 1 ]; then
  echo "‚úÖ All regression tests passed"
else
  echo "‚ÑπÔ∏è  No critical files modified, skipping regression tests"
fi

echo "‚úÖ Pre-commit checks complete"
