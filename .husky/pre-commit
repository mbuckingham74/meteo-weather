#!/bin/sh
# Unified pre-commit hook for Meteo Weather App
# Runs linting, formatting, and regression tests

echo "üöÄ Running pre-commit checks..."

# 1. Run lint-staged for frontend (formatting & linting)
if git diff --cached --name-only | grep -q "^frontend/"; then
  echo ""
  echo "üìù Running frontend lint-staged..."
  cd frontend
  npx lint-staged
  if [ $? -ne 0 ]; then
    echo "‚ùå Frontend linting/formatting failed"
    exit 1
  fi
  cd ..
  echo "‚úÖ Frontend linting/formatting passed"
fi

# 2. Run lint-staged for backend (formatting & linting)
if git diff --cached --name-only | grep -q "^backend/.*\.js$"; then
  echo ""
  echo "üìù Running backend lint-staged..."
  cd backend

  # Get staged backend files
  STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "^backend/.*\.js$" | sed 's|^backend/||')

  if [ -n "$STAGED_FILES" ]; then
    # Run prettier
    echo "$STAGED_FILES" | xargs npx prettier --write

    # Run eslint
    echo "$STAGED_FILES" | xargs npx eslint --fix

    # Re-stage formatted files
    echo "$STAGED_FILES" | sed 's|^|backend/|' | xargs git add
  fi

  cd ..
  echo "‚úÖ Backend linting/formatting passed"
fi

# 3. Run regression tests (from existing pre-commit-regression-check)
echo ""
echo "üîç Running critical regression tests..."

FRONTEND_CHANGED=0
BACKEND_CHANGED=0

# Check if geolocationService.js was modified (FRONTEND)
if git diff --cached --name-only | grep -q "frontend/src/services/geolocationService.js"; then
  echo "‚ö†Ô∏è  Frontend geolocationService.js modified - running regression tests..."
  FRONTEND_CHANGED=1

  cd frontend
  npm run test -- geolocationService.regression.test.js --run

  if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå CRITICAL REGRESSION DETECTED IN FRONTEND!"
    echo ""
    echo "The 'Old Location' bug has been re-introduced in geolocationService.js"
    echo "Please fix the issues before committing."
    echo ""
    echo "See: docs/REGRESSION_PREVENTION.md"
    echo ""
    exit 1
  fi

  echo "‚úÖ Frontend regression tests passed"
  cd ..
fi

# Check if LocationContext.jsx was modified (FRONTEND)
if git diff --cached --name-only | grep -q "frontend/src/contexts/LocationContext.jsx"; then
  echo "‚ö†Ô∏è  Frontend LocationContext.jsx modified - running regression tests..."
  FRONTEND_CHANGED=1

  cd frontend
  npm run test -- LocationContext.regression.test.jsx --run

  if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå CRITICAL REGRESSION DETECTED IN FRONTEND!"
    echo ""
    echo "See: docs/REGRESSION_PREVENTION.md"
    echo ""
    exit 1
  fi

  echo "‚úÖ LocationContext regression tests passed"
  cd ..
fi

# Check if weatherService.js was modified (BACKEND)
if git diff --cached --name-only | grep -q "backend/services/weatherService.js"; then
  echo "‚ö†Ô∏è  Backend weatherService.js modified - running regression tests..."
  BACKEND_CHANGED=1

  cd backend
  npm test -- weatherService.regression.test.js

  if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå CRITICAL REGRESSION DETECTED IN BACKEND!"
    echo ""
    echo "See: docs/REGRESSION_PREVENTION.md"
    echo ""
    exit 1
  fi

  echo "‚úÖ Backend regression tests passed"
  cd ..
fi

if [ $FRONTEND_CHANGED -eq 1 ] || [ $BACKEND_CHANGED -eq 1 ]; then
  echo "‚úÖ All regression tests passed"
else
  echo "‚ÑπÔ∏è  No critical files modified, skipping regression tests"
fi

echo ""
echo "‚úÖ All pre-commit checks passed! Ready to commit."
